# V2V-Raft-SDR åè®®ç‰¹æ€§è¯´æ˜

æœ¬æ–‡æ¡£æè¿°äº† V2V-Raft-SDR é¡¹ç›®çš„ Raft å…±è¯†ç®—æ³•å®ç°ã€‚

---

## ğŸ“‹ å½“å‰å®ç°

æœ¬é¡¹ç›®å®ç°äº†**æ ‡å‡† Raft å…±è¯†ç®—æ³•**ï¼Œé€‚é…äº† SDR æ— çº¿å¹¿æ’­ç¯å¢ƒã€‚

| ç‰¹æ€§ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **Leader é€‰ä¸¾** | âœ… å·²å®ç° | å›ºå®šè¶…æ—¶ + éšæœºæŠ–åŠ¨ |
| **æ—¥å¿—å¤åˆ¶** | âœ… å·²å®ç° | Leader å¹¿æ’­å¤åˆ¶ |
| **å®‰å…¨æ€§ä¿è¯** | âœ… å·²å®ç° | Term æ£€æŸ¥ã€æ—¥å¿—ä¸€è‡´æ€§ |
| **å¹¿æ’­æ¨¡å¼é€‚é…** | âœ… å·²å®ç° | é€‚åº” SDR æ— çº¿å¹¿æ’­ç‰¹æ€§ |

---

## 1. é€‰ä¸¾è¶…æ—¶æœºåˆ¶

### æ ‡å‡† Raft å®ç°

é€‰ä¸¾è¶…æ—¶é‡‡ç”¨**å›ºå®šèŒƒå›´ + éšæœºæŠ–åŠ¨**ï¼š

```python
def _calculate_election_timeout(self):
    """åŸºç¡€ Raft é€‰ä¸¾è¶…æ—¶: å›ºå®šèŒƒå›´ + éšæœºæŠ–åŠ¨"""
    return random.uniform(self.election_timeout_min, self.election_timeout_max)
```

### å‚æ•°é…ç½®

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `election_timeout_min` | 1.5s | é€‰ä¸¾è¶…æ—¶ä¸‹é™ |
| `election_timeout_max` | 3.0s | é€‰ä¸¾è¶…æ—¶ä¸Šé™ |
| `heartbeat_interval` | 0.15s | Leader å¿ƒè·³é—´éš” |

### è®¾è®¡åŸåˆ™

- **å¿ƒè·³é—´éš” << é€‰ä¸¾è¶…æ—¶**ï¼šç¡®ä¿æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šè§¦å‘é€‰ä¸¾
- **éšæœºåŒ–**ï¼šé¿å…å¤šèŠ‚ç‚¹åŒæ—¶å‘èµ·é€‰ä¸¾ï¼ˆSplit Voteï¼‰
- **é€‚é… SDR å»¶è¿Ÿ**ï¼šå‚æ•°åŸºäºå®æµ‹ RTT (~30ms) è°ƒæ•´

---

## 2. Leader é€‰ä¸¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     è¶…æ—¶      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Follower   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Candidate  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–²                             â”‚
       â”‚                      å‘èµ· RequestVote
       â”‚                             â”‚
       â”‚                             â–¼
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   æ”¶åˆ°æ›´é«˜ Term     â”‚ æ”¶é›†æŠ•ç¥¨        â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ votes > N/2?   â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                             â”‚ æ˜¯
       â”‚                             â–¼
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Leader    â”‚
            ä»»æœŸç»“æŸ         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ—¥å¿—å¤åˆ¶

### æµç¨‹

1. **Client æäº¤å‘½ä»¤** â†’ Leader
2. **Leader è¿½åŠ æœ¬åœ°æ—¥å¿—**
3. **Leader å¹¿æ’­ AppendEntries** â†’ æ‰€æœ‰ Follower
4. **Follower è¿½åŠ æ—¥å¿—å¹¶å“åº”**
5. **Leader æ”¶åˆ°å¤šæ•°æ´¾ç¡®è®¤** â†’ æäº¤æ—¥å¿—
6. **ä¸‹æ¬¡å¿ƒè·³é€šçŸ¥ Follower** â†’ åº”ç”¨åˆ°çŠ¶æ€æœº

### å¹¿æ’­æ¨¡å¼ä¼˜åŒ–

ç”±äº SDR æ˜¯æ— çº¿å¹¿æ’­ï¼Œä¼˜åŒ–ä¸ºåªå‘é€ä¸€æ¬¡ï¼š

```python
def _replicate_log(self):
    """Leader å‘æ‰€æœ‰ Follower å¤åˆ¶æ—¥å¿— (å¹¿æ’­æ¨¡å¼: åªå‘ä¸€æ¬¡)"""
    # è®¡ç®—éœ€è¦å‘é€çš„æ—¥å¿—æ¡ç›®
    entries = self.log[min_next_index:]
    msg = RaftMessage(type="AppendEntries", entries=entries, ...)
    self._broadcast(msg)  # åªå¹¿æ’­ä¸€æ¬¡
```

---

## 4. æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ç±»å‹ | å‘é€æ–¹ | ç”¨é€” |
|----------|--------|------|
| `RequestVote` | Candidate | è¯·æ±‚æŠ•ç¥¨ |
| `VoteResponse` | All | æŠ•ç¥¨å“åº” |
| `AppendEntries` | Leader | å¿ƒè·³ / æ—¥å¿—å¤åˆ¶ |
| `AppendEntriesResponse` | Follower | å¤åˆ¶ç¡®è®¤ |

---

## 5. æ•°æ®ç»“æ„

### LogEntry

```python
@dataclass
class LogEntry:
    term: int           # åˆ›å»ºæ—¶çš„ä»»æœŸ
    index: int          # æ—¥å¿—ç´¢å¼•
    command: str        # å‘½ä»¤å†…å®¹
    timestamp: float    # æ—¶é—´æˆ³
```

### RaftMessage

```python
@dataclass  
class RaftMessage:
    type: str           # æ¶ˆæ¯ç±»å‹
    term: int           # å‘é€æ–¹ä»»æœŸ
    sender_id: int      # å‘é€æ–¹ ID
    entries: List[LogEntry]  # æ—¥å¿—æ¡ç›® (AppendEntries)
    leader_commit: int  # Leader å·²æäº¤ç´¢å¼•
    # ... å…¶ä»–å­—æ®µ
```

---

## 6. ä¸æ ‡å‡† Raft çš„ä¸€è‡´æ€§

æœ¬å®ç°ä¸¥æ ¼éµå¾ª Raft è®ºæ–‡ï¼Œä¿è¯ä»¥ä¸‹æ€§è´¨ï¼š

| æ€§è´¨ | è¯´æ˜ |
|------|------|
| **Election Safety** | æ¯ä¸ª Term æœ€å¤šä¸€ä¸ª Leader |
| **Leader Append-Only** | Leader åªè¿½åŠ æ—¥å¿—ï¼Œä¸åˆ é™¤ |
| **Log Matching** | ç›¸åŒ index+term çš„æ—¥å¿—å†…å®¹ç›¸åŒ |
| **Leader Completeness** | å·²æäº¤æ—¥å¿—åœ¨æœªæ¥ Leader ä¸­å­˜åœ¨ |
| **State Machine Safety** | æ‰€æœ‰èŠ‚ç‚¹ä»¥ç›¸åŒé¡ºåºåº”ç”¨ç›¸åŒæ—¥å¿— |

---

## ğŸ”§ é…ç½®å‚æ•°

```python
# åŸºç¡€ Raft å‚æ•°
election_timeout_min = 1.5    # é€‰ä¸¾è¶…æ—¶ä¸‹é™ (ç§’)
election_timeout_max = 3.0    # é€‰ä¸¾è¶…æ—¶ä¸Šé™ (ç§’)
heartbeat_interval = 0.15     # å¿ƒè·³é—´éš” (ç§’)
```

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

1. Ongaro, D., & Ousterhout, J. (2014). *In Search of an Understandable Consensus Algorithm (Raft)*. USENIX ATC.

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0 (åŸºç¡€ Raft)*  
*æœ€åæ›´æ–°: 2026-01-19*
